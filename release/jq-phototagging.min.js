/*! jq-phototagging 2013-12-08 */
!function(a,b){"use strict";!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(c){var d="jqPhotoTagging",e=".jqphototagging",f="jq-phototagging-",g=f+"img",h=f+"wrapper",i=f+"tag-boxes",j=f+"tag-box",k=f+"tags",l=f+"tag",m=f+"visible",n=f+"form",o=f+"form-box",p=f+"right",q=f+"left",r=f+"readonly",s="icon-remove icon-white",t=function(){},u=function(){return!0},v=function(a){return a},w=function(a){return a!==b&&null!==a},x=function(a){for(var b=!0,d="";b;)d=Math.round((new Date).getTime()+100*Math.random()),d=d.toString(),b=a.hasOwnProperty(d)||c("#"+d).length>0;return d},y=function(a,b){var c=b||"name";return a[c]||""},z=function(a){return{x:a.x,y:a.y,width:a.width,height:a.height}},A=function(a){return{width:a.imgWidth,height:a.imgHeight}},B=function(a,b,c){var d={width:c.width(),height:c.height()},e=a.width/d.width,f=a.height/d.height;return{x:b.x/e,y:b.y/f,width:b.width/e,height:b.height/f}},C=function(a,c,d){var e="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.bind("load.imgloaded",function(){a.unbind("load.imgloaded"),c.call(d)}).each(function(){var a=this;if(a.complete||a.complete===b){var c=a.src;a.src=e,a.src=c}})},D=function(a,c){var d=a.attr("data-"+c);return""===d&&(d=b),d},E=function(a,b){var d=this;d.$img=c(a),d.opts=c.extend({},b,d.readDatas()),d.fx=0,d.width=b.width,d.height=b.height,d.x=0,d.y=0,d.$ids={},d.tags=[]};E.prototype={init:function(){var a=this,b=a.$img;b.addClass(g);var d=c("<div></div>").addClass(h);b.wrap(d),d=b.parent();var e=a.opts.$tags;e&&(e=c(e),e.length>0&&("UL"!==e.get(0).tagName&&(e=c("<ul></ul>").appendTo(e)),e.addClass(k)));var f=c("<div></div>").addClass(i).appendTo(d);a.$wrapper=d,a.$tags=e||c("<ul></ul>"),a.$boxes=f,a.appendForm(),a.readOnly()&&d.addClass(r),a.opts.onInitialized.call(a,a.$wrapper,a.$form),C(a.$img,a.onLoaded,a)},readDatas:function(){var a={},b=this.$img;return a.width=D(b,"width"),a.height=D(b,"height"),a.url=D(b,"url"),a.method=D(b,"method"),a.dataType=D(b,"data-type"),a.readOnly=D(b,"read-only"),a.label=D(b,"label"),a.$tags=D(b,"tags"),w(a.width)&&(a.width=parseFloat(a.width)),w(a.height)&&(a.height=parseFloat(a.height)),w(a.readOnly)&&(a.readOnly="true"===a.readOnly),a},appendForm:function(){var a=this,b=c("<form></form>").addClass(n).appendTo(a.$wrapper),d=c("<div></div>").addClass(o).css({width:a.width,height:a.height}).appendTo(b),e=c('<input type="text"/>').appendTo(b),f=c("<i></i>").addClass(s).appendTo(d);a.$form=b,a.$input=e,a.$box=d,a.$iconRemove=f},removeForm:function(){var a=this;a.$iconRemove.remove(),a.$input.remove(),a.$box.remove(),a.$form.remove()},toggleReadOnly:function(){var a=this;a.opts.readOnly=!a.opts.readOnly,a.opts.readOnly?(a.hideForm(),a.$wrapper.addClass(r)):a.$wrapper.removeClass(r)},readOnly:function(a){return w(a)?(this.opts.readOnly!==a&&this.toggleReadOnly(),void 0):this.opts.readOnly},onLoaded:function(){var a=this;a.computeSize(),a.$tags.html(""),a.appendTags(a.opts.tags||[]),a.opts.onLoaded.call(a,a.tags,a.$tags),a.bind()},computeSize:function(){var a=this,b=0,c=0,d=0,e=a.$img,f=a.$form;a.$imgHeight=e.outerHeight(),a.$imgWidth=e.outerWidth(),f&&(b=f.outerWidth(),c=f.outerHeight(),d=(b-a.width)/2,0>d&&(d=0)),a.marginWidth=d,a.formWidth=b,a.formHeight=c},bind:function(){var a=this;a.$tags.on("mouseenter"+e,"li",function(){var b=c(this),d=b.attr("data-id");a.$boxes.find("#"+d).addClass(m)}),a.$tags.on("mouseleave"+e,"li",function(){a.$boxes.find("div").removeClass(m)}),a.bindForm()},bindForm:function(){var b=this;b.$img.on("click"+e,function(d){if(!b.readOnly()){d.stopPropagation();var e=c(this),f=c(a),g=e.offset(),h=g.top-f.scrollTop(),i=g.left-f.scrollLeft(),j=b.formWidth/2,k=b.formHeight/2,l=d.clientX-i-j,m=d.clientY-h-k;b.showForm(l,m)}}),b.$form.on("submit"+e,function(a){a.preventDefault(),b.submit(b.val())}),b.$input.on("keyup"+e,function(a){27===a.keyCode&&b.hideForm()}),b.$iconRemove.on("click"+e,function(){b.hideForm()})},unbindForm:function(){this.$img.off("click"+e),this.$form.unbind(e),this.$iconRemove.off(e)},val:function(a){if(w(a)){var b="string"==typeof a||a instanceof c?a:this.renderTag(a);b instanceof c&&(b=b.text()),this.$input.val(c.trim(b))}return c.trim(this.$input.val())},showForm:function(a,b){var c=this,d=c.formWidth,e=c.width,f=c.height,g=c.$box,h=c.$form,i=c.$imgWidth,j=c.$imgHeight;g.removeClass(q).removeClass(p);var k=a+c.marginWidth,l=b;0>a&&(a=0,k=0,g.addClass(q)),0>b&&(b=0,l=0);var m=a+d,n=b+f;m>i&&(a=i-d,k=i-e,g.addClass(p)),n>j&&(b=j-f,l=j-f),c.fx=a,c.x=k,c.y=l,h.css({left:a,top:b}),h.show(),c.$input.focus(),c.opts.onShown.call(c,c.position())},hideForm:function(){var a=this;a.$form.fadeOut("fast"),a.clear(),a.opts.onHidden.call(a)},clear:function(){this.val(""),this.opts.onClear.call(this)},submit:function(a){var b=this;if(a&&!b.$submitting){a=b.val(a),b.$submitting=!0;var d=b.params(a);if(!b.opts.isValid.call(b,a,d))return b.$submitting=!1,void 0;var e=c.ajax({url:b.opts.url,type:b.opts.method,data:d,dataType:b.opts.dataType});e.done(function(a){b.opts.onSavedSuccess.apply(b,arguments),b.hideForm();var c=b.opts.resultFn.call(b,a);b.appendTags(c)}),e.fail(function(){b.opts.onSavedFailed.apply(b,arguments)}),e.always(function(){b.$submitting=!1})}},params:function(a){var b=this.position();b.value=a;var d=this.opts.paramsFn.call(this,b);return c.extend(b,d)},position:function(){var a=this;return{x:a.x,y:a.y,width:a.width,height:a.height,imgWidth:a.$imgWidth,imgHeight:a.$imgHeight}},appendTags:function(a){c.isArray(a)||(a=[a]),this.tags=this.tags.concat(a);for(var b=0,d=a.length;d>b;++b)this.appendTag(a[b])},appendTag:function(a){var b=this,d=b.opts,e=d.imgSize.call(a,a),f=d.tagSize.call(a,a),g=d.ratio.call(a,e,f,b.$img),h=x(b.$ids);b.$ids[h]=!0;var i=g.width,k=c("<div></div>").addClass(j).attr("id",h).css({width:i,top:g.y,left:g.x}).appendTo(b.$boxes);c("<div></div>").css({height:g.height}).appendTo(k);var m=b.renderTag(a),n=m;n instanceof c&&(n=n.text()),c("<span></span>").html(n).appendTo(k);var o=c("<li></li>").addClass(l).attr("data-id",h).html(m);b.$tags.append(o)},renderTag:function(a){var b=this.opts.label,d=null;return c.isFunction(b)||(d=b,b=y),b.call(null,a,d)},unbind:function(){this.$tags.off(e),this.$form&&this.unbindForm()},destroy:function(){var a=this;a.opts.onDestroyed.call(a),a.unbind(),a.removeForm(),a.$tags.remove(),a.$wrapper.unwrap();for(var b in a)a.hasOwnProperty(b)&&(a[b]=null)}},c.fn.jqPhotoTagging=function(a){var b=this,e=c(this);b.destroy=function(){e.data(d).destroy(),e.removeData(d)},b.val=function(a){var b=e.data(d);return w(a)?(b.val(a),this):b.val()},b.submit=function(a){var b=e.data(d);return w(a)&&b.val(a),b.submit(b.val()),this},b.position=function(){return e.data(d).position()},b.readOnly=function(a){return w(a)?(e.data(d).readOnly(!!a),this):e.data(d).readOnly()},b.toggleReadOnly=function(){return e.data(d).toggleReadOnly(),this};var f=arguments;return b.each(function(){var e=c(this),g=e.data(d);if(!g){var h=c.extend({},c.fn.jqPhotoTagging.options);"object"==typeof a&&(h=c.extend(h,a)),g=new E(e,h),g.init()}e.data(d,g),f.length>0&&"string"==typeof f[0]&&b[f[0]].apply(b,Array.prototype.slice.call(f,1))})},c.fn.jqPhotoTagging.options={width:100,height:100,url:"",method:"POST",dataType:"json",readOnly:!1,label:y,tagSize:z,imgSize:A,ratio:B,tags:[],$tags:null,paramsFn:v,resultFn:v,onInitialized:t,onLoaded:t,onDestroyed:t,isValid:u,onShown:t,onHidden:t,onClear:t,onSavedSuccess:t,onSavedFailed:t}})}(window,void 0);